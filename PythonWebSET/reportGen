import os
from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, Image
from reportlab.lib.pagesizes import A4
from reportlab.lib.styles import getSampleStyleSheet

def generate_pdf(results,pdf_path="WebSET_Report.pdf", severity_chart_path="severity_bar.png", threat_chart_path="threats_bar.png"):
    style = getSampleStyleSheet()
    doc = SimpleDocTemplate(pdf_path, pagesize=A4)
    story = []

    story.append(Paragraph("WebSET Scan Results", style["Title"]))
    story.append(Spacer(1, 12))
    story.append(Paragraph("Scan Results", style["Heading2"]))

    if os.path.exists(severity_chart_path):
        story.append(Image(severity_chart_path, width=420, height=250))
        story.append(Spacer(1, 8))
    if os.path.exists(threat_chart_path):
        story.append(Image(threat_chart_path, width=420, height=250))
        story.append(Spacer(1, 12))

    data = [["Threat", "Severity", "Message"]]
    for issue in results.get("issues", []):
        thrt = issue.get("Threat", "")
        sevrty = issue.get("Threat Severity", "")
        msg = (issue.get("Message", "") or "").replace("\n", " ")
        if len(msg) > 140:
            msg = msg[:137] + "..."
        data.append([thrt, sevrty, msg])

    if len(data) == 1:
        data.append(["—", "—", "No issues found."])

    table = Table(data, colWidths=[180, 100, 240])
    story.append(table)

    doc.build(story)
    print(f"PDF report saved to {pdf_path}")
